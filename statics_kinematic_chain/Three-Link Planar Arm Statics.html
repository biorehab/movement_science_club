<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three-Link Planar Arm Statics</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            display: flex;
        }
        .controls {
            width: 30%;
            padding: 20px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        .results {
            width: 70%;
            padding: 20px;
        }
        #plot {
            border: none; /* 1px solid #ccc; */
            background-color: #ffffff;
    }
        }
    </style>
</head>
<body>

<div class="controls">
    <h2>Controls</h2>
    <div class="control-group">
        <label>Link 1 Length (m): <span id="l1Value">0.3</span></label>
        <input type="range" id="l1" min="0.1" max="0.6" step="0.01" value="0.3">
    </div>
    <div class="control-group">
        <label>Link 2 Length (m): <span id="l2Value">0.35</span></label>
        <input type="range" id="l2" min="0.1" max="0.6" step="0.01" value="0.35">
    </div>
    <div class="control-group">
        <label>Link 3 Length (m): <span id="l3Value">0.2</span></label>
        <input type="range" id="l3" min="0.05" max="0.6" step="0.01" value="0.2">
    </div>
    <div class="control-group">
        <label>Joint Angle 1 (deg): <span id="theta1Value">0</span></label>
        <input type="range" id="theta1" min="0" max="180" step="0.1" value="0">
    </div>
    <div class="control-group">
        <label>Joint Angle 2 (deg): <span id="theta2Value">0</span></label>
        <input type="range" id="theta2" min="0" max="180" step="0.1" value="90">
    </div>
    <div class="control-group">
        <label>Joint Angle 3 (deg): <span id="theta3Value">0</span></label>
        <input type="range" id="theta3" min="0" max="180" step="0.1" value="45">
    </div>
    <div class="control-group">
        <label>Joint Torque 1 (deg): <span id="torque1Value">0</span></label>
        <input type="range" id="torque1" min="-3" max="3" step="0.01" value="0">
    </div>
    <div class="control-group">
        <label>Joint Torque 2 (deg): <span id="torque2Value">0</span></label>
        <input type="range" id="torque2" min="-3" max="3" step="0.01" value="0">
    </div>
    <div class="control-group">
        <label>Joint Torque 3 (deg): <span id="torque3Value">0</span></label>
        <input type="range" id="torque3" min="-3" max="3" step="0.01" value="0">
    </div>
</div>

<!-- Plot area in white background with no boder. -->
<div class="results">
    <h2>Three Link Arm Visualization</h2>
    <svg id="plot" width="500" height="500">
        <line x1="0" y1="250" x2="500" y2="250" stroke="black"/> <!-- X-axis -->
        <line x1="250" y1="0" x2="250" y2="500" stroke="black"/> <!-- Y-axis -->
    </svg>
</div>

<div class="results">
    <p><strong>End-Effector Position (m):</strong>
        [<span id="xPos">0.00</span>,
        <span id="yPos">0.00</span>]
    </p>
    <p><strong>Joint Torque (Nm): </strong>
        [<span id="torque1">0.00</span>, 
        <span id="torque2">0.00</span>, 
        <span id="torque3">0.00</span>]
    </p>
</div>

<script>
    // Page level constants
    const lengthToPixelScale = 250;
    const svg = d3.select("#plot");
    const width = +svg.attr("width");
    const height = +svg.attr("height");
    const origin = {x: width/2, y: height/2};

    // Update slider values
    document.querySelectorAll('input[type="range"]').forEach(input => {
        const id = input.id;
        const value = document.getElementById(id + 'Value');
        input.addEventListener('input', () => {
            value.innerText = input.value;
        });
    });

    // Three link arm class.
    class ThreeLinkArm {
        constructor(lengths, angles) {
            this.lengths = lengths;
            this.angles = angles;
        }
    
        setAngles(newAngles) {
            this.angles = newAngles;
        }

        setLengths(newLengths) {
            this.lengths = newLengths;
        }
    
        getArmPositions() {
            const cusumtheta = cummulativeSum(this.angles);
            const x1 = 0, y1 = 0;
            const x2 = this.lengths[0] * Math.cos(cusumtheta[0]);
            const y2 = this.lengths[0] * Math.sin(cusumtheta[0]);
            const x3 = x2 + this.lengths[1] * Math.cos(cusumtheta[1]);
            const y3 = y2 + this.lengths[1] * Math.sin(cusumtheta[1]);
            const x4 = x3 + this.lengths[2] * Math.cos(cusumtheta[2]);
            const y4 = y3 + this.lengths[2] * Math.sin(cusumtheta[2]);
            return [[x1, y1], [x2, y2], [x3, y3], [x4, y4]];
        }
    }

    // Useful Functions
    function mapPositionsToCoordinates(positions, origin) {
        return positions.map(pos => [origin.x + pos[0] * lengthToPixelScale,
                                    origin.y - pos[1] * lengthToPixelScale]);
    }

    function degreesToRadians(degreesArray) {
        return degreesArray.map(deg => deg * Math.PI / 180);
    }

    function cummulativeSum(array) {
        return array.reduce((acc, curr) => {
            acc.push(acc[acc.length - 1] + curr);
            return acc;
        }, [0]).slice(1);
    }

    function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
        const angleInRadians = angleInDegrees;
        return {
            x: centerX + (radius * Math.cos(angleInRadians)),
            y: centerY + (radius * Math.sin(angleInRadians))
        };
    }

    function describeArc(x, y, radius, startAngle, endAngle) {
        const start = polarToCartesian(x, y, radius, endAngle);
        const end = polarToCartesian(x, y, radius, startAngle);
        const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
        const sweetDir = endAngle - startAngle >= 0 ? "0" : "1"
        return `
            M ${start.x} ${start.y}
            A ${radius} ${radius} 0 ${largeArcFlag} ${sweetDir} ${end.x} ${end.y}
        `;
    }
    // End of useful functions

    // Other plotting related functions.
    function getJoinTorqueArcInfo(angle, torque, scale=0.5) {
        const taustrtang = angle;
        const tauendang = angle + torque * Math.PI * scale;
        return [taustrtang, tauendang];
    }
    // End of other plotting related functions.

    function updateArm() {
        // Get new lengths and angles
        const lengths = [
            +document.getElementById('l1').value,
            +document.getElementById('l2').value,
            +document.getElementById('l3').value
        ];

        const theta = [
            +document.getElementById('theta1').value,
            +document.getElementById('theta2').value,
            +document.getElementById('theta3').value
        ];

        const torque = [
            +document.getElementById('torque1').value,
            +document.getElementById('torque2').value,
            +document.getElementById('torque3').value
        ]

        // Convert to radians
        const thetar = degreesToRadians(theta);

        // Update arm lengths and angles
        arm.setLengths(lengths);
        arm.setAngles(thetar);

        // Update visualization
        const armpos = arm.getArmPositions();
        updateArmVisualization(armpos, origin, torque);

        // Update end-effector position
        document.getElementById('xPos').innerText = armpos[3][0].toFixed(2);
        document.getElementById('yPos').innerText = armpos[3][1].toFixed(2);

        // Dummy torque calculation (replace with real equations)
        document.getElementById('torque1').innerText = (lengths[0] * Math.sin(thetar[0])).toFixed(2);
        document.getElementById('torque2').innerText = (lengths[1] * Math.sin(thetar[1])).toFixed(2);
        document.getElementById('torque3').innerText = (lengths[2] * Math.sin(thetar[2])).toFixed(2);
    }

    function updateArmVisualization(armpos, origin, torque) {
        svg.selectAll("line").remove();
        svg.selectAll("circle").remove();
        svg.selectAll("path").remove();

        // Add the x and y axis.
        svg.append("line").attr("x1", 0).attr("y1", origin.y)
        .attr("x2", width).attr("y2", origin.y).attr("stroke", "lightgray").attr("stroke-width", 0.5);
        svg.append("line").attr("x1", origin.x).attr("y1", 0)
        .attr("x2", origin.x).attr("y2", height).attr("stroke", "lightgray").attr("stroke-width", 0.5);
        
        // Map arm positions to x and y coordinates
        armpos = mapPositionsToCoordinates(armpos, origin);

        // Draw links
        for (let i = 0; i < armpos.length - 1; i++) {
            svg.append("line")
                .attr("x1", armpos[i][0])
                .attr("y1", armpos[i][1])
                .attr("x2", armpos[i+1][0])
                .attr("y2", armpos[i+1][1])
                .attr("stroke", "#8888ff")
                .attr("stroke-width", 2);
        }

        // Draw joints
        armpos.slice(0, -1).forEach(pos => {
            svg.append("circle")
                .attr("cx", pos[0])
                .attr("cy", pos[1])
                .attr("r", 3)
                .attr("stroke", "#8888ff")
                .attr("fill", "#ffffff");
        });

        // Draw the torque arcs around joints.
        const cusumangles = cummulativeSum(arm.angles);
        const torqArcAngles = cusumangles.map((angle, i) => getJoinTorqueArcInfo(angle, torque[i]));
        torqArcAngles.forEach((angles, i) => {
            const arcPath = describeArc(armpos[i][0], armpos[i][1], 20, angles[0], angles[1]);
            svg.append("path")
                .attr("d", arcPath)
                .attr("stroke", "red")
                .attr("fill", "none")
                .attr("stroke-width", 1.5);
        });

        // // Start angle and end angle for the arc.
        // const taustrtang = arm.angles[0];
        // const tauendang = arm.angles[0] + torque[0] * Math.PI * 0.5;
        // const arcPath = describeArc(armpos[0][0], armpos[0][1], 20, taustrtang, tauendang);
        // svg.append("path")
        //     .attr("d", arcPath)
        //     .attr("stroke", "red")
        //     .attr("fill", "none")
        //     .attr("stroke-width", 1.5);
    }

    // Create the arm object once and reuse it
    const arm = new ThreeLinkArm(
        [1, 1, 1], // Initial lengths
        degreesToRadians([0, 0, 0]) // Initial angles
    );

    // Attach event listeners to sliders
    ['l1', 'l2', 'l3', 'theta1', 'theta2', 'theta3', 'torque1', 'torque2', 'torque3'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateArm);
    });

    // Initialize the arm visualization
    updateArm();
</script>

</body>
</html>